<!-- h1 と line-length はスルーさせる -->
<!-- markdownlint-disable MD013 MD025 -->

# 09/08

## はじめまして

TIL を始めてみる。

リポジトリ構成は技術カテゴリーで切ったり、月日で切ったり人それぞれっぽい。

とりあえず月ごとのファイルを作成して h1 で日付、h2 でトピックでやってみる。  

X にかくより詳細にブログに書く材料に。くらいのイメージで

# 09/09

## GitHub CLI でディレクトリごとに認証する

gh コマンドで実現するパターン

会社アカウントと個人アカウントを使い分ける場合

ログイン状況確認

```sh
gh auth status
```

会社用アカウントでログインしている

```sh
~/personal/til +[chore/20250909]$ gh auth status 
github.com
  ✓ Logged in to github.com account company_account (keyring)
  - Active account: true
  - Git operations protocol: https
  - Token: gho_************************************
  - Token scopes: 'gist', 'read:org', 'repo', 'workflow'
```

個人アカウントをブラウザでログインした状態でログインを実施する

```sh
gh auth login
```

個人アカウントにログインできる

```sh
~/personal/til +[chore/20250909]$ gh auth login 
? Where do you use GitHub? GitHub.com
? What is your preferred protocol for Git operations on this host? HTTPS
? Authenticate Git with your GitHub credentials? Yes
? How would you like to authenticate GitHub CLI? Login with a web browser

! First copy your one-time code: xxxx-xxxx
Press Enter to open https://github.com/login/device in your browser... 
✓ Authentication complete.
- gh config set -h github.com git_protocol https
✓ Configured git protocol
✓ Logged in as personal_account
```

ログイン状態の確認をすると以下

```sh
~/personal/til +[chore/20250909]$ gh auth status
github.com
  ✓ Logged in to github.com account personal_account (keyring)
  - Active account: true
  - Git operations protocol: https
  - Token: gho_************************************
  - Token scopes: 'gist', 'read:org', 'repo', 'workflow'

  ✓ Logged in to github.com account company_account (keyring)
  - Active account: false
  - Git operations protocol: https
  - Token: gho_************************************
  - Token scopes: 'gist', 'read:org', 'repo', 'workflow'
```

`Active account: true` になっている方が今選択されているアカウント

切り替えるには auth switch で切り替える

```sh
gh auth swith
```

次のように表示される

```sh
~/personal/til +[chore/20250909]$ gh auth switch
✓ Switched active account for github.com to company_account
```

これでもいいけど特定ディレクトリ配下だけ固定しておきたい。
明日ためそう。

# 09/10

## lefthook

Go で書かれた Git の hook を管理するツール

- <https://github.com/evilmartians/lefthook>
- <https://lefthook.dev/>

Huskey では Node 環境が必要だがこちらはバイナリのみで動作する

### Why lefthook

<https://github.com/evilmartians/lefthook?tab=readme-ov-file#why-lefthook>

Lefthook のよいところ

- 並列実行が可能な parallel オプションが有る
- Glob と filter で実行対象の絞り込みや除外が柔軟に可能
- ジョブごとに Current Working Directory を指定することができ、モノレポ構成等でも設定しやすい
- 任意のコマンドだけではなくスクリプトを実行することもできる
- docker イメージの実行も可能
- lefthook.yml を利用して hook を管理することができ、lefthook-local.yml を用意することで個人設定も追加可能
- lefthook run pre-commit で随時実行も可能
- タスクランナー的利用方法もできる

### 所感

設定して使ってみたけど便利。並列実行はコミットで待たされることがなくよさそう

このリポジトリでも設定してみるか

# 09/11

## kms の alias の terraform import

import しようとすると `Error: Cannot import non-existent remote object` が表示されて困った

```imports.tf
import {
  to = aws_kms_key.hoge
  id = "arn:aws:kms:....."
}

import {
  to = aws_kms_alias.hoge
  id = "dev/kagidayo"
}
```

問題なさそうに見えていたのだが正しくはこう

```tf
import {
  to = aws_kms_key.hoge
  id = "arn:aws:kms:....."
}

import {
  to = aws_kms_alias.hoge
  id = "alias/dev/kagidayo"
}
```

`alias/` が抜けていたのであった....

```diff
 import {
   to = aws_kms_alias.hoge
-  id = "dev/kagidayo"
+  id = "alias/dev/kagidayo"
 }
```

30分くらい調べたよ...

# 09/12

## pre-commit hook 試してみる

テキストとマークダウンの lint を試してみる

[markdownlint-cli2](https://github.com/DavidAnson/markdownlint-cli2) という linter が brew でインストールできるらしい

インストールして lefthook に設定してみる

```yaml:lefthook.yml
---
pre-commit:
  jobs:
    - name: markdownlint
      glob: "*.md"
      run: markdownlint-cli2 {staged_files}
```

手動で `lefthook run pre-commit` してみた

```sh
~/personal/til ![chore/20250912]$ lefthook run pre-commit                    
╭───────────────────────────────────────╮
│ 🥊 lefthook v1.12.3  hook: pre-commit │
╰───────────────────────────────────────╯
sync hooks: ✔️ (pre-commit)
┃  markdownlint ❯ 

markdownlint-cli2 v0.18.1 (markdownlint v0.38.0)
Finding: 202509.md
Linting: 1 file(s)
Summary: 19 error(s)
202509.md:13 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/09"]
202509.md:22 MD031/blanks-around-fences Fenced code blocks should be surrounded by blank lines [Context: "```sh"]
202509.md:27 MD031/blanks-around-fences Fenced code blocks should be surrounded by blank lines [Context: "```sh"]
202509.md:38 MD031/blanks-around-fences Fenced code blocks should be surrounded by blank lines [Context: "```sh"]
202509.md:43 MD031/blanks-around-fences Fenced code blocks should be surrounded by blank lines [Context: "```sh"]
202509.md:59 MD031/blanks-around-fences Fenced code blocks should be surrounded by blank lines [Context: "```sh"]
202509.md:84 MD031/blanks-around-fences Fenced code blocks should be surrounded by blank lines [Context: "```sh"]
202509.md:92 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/10"]
202509.md:97 MD032/blanks-around-lists Lists should be surrounded by blank lines [Context: "- https://github.com/evilmarti..."]
202509.md:97:3 MD034/no-bare-urls Bare URL used [Context: "https://github.com/evilmartian..."]
202509.md:98:3 MD034/no-bare-urls Bare URL used [Context: "https://lefthook.dev/"]
202509.md:102 MD022/blanks-around-headings Headings should be surrounded by blank lines [Expected: 1; Actual: 0; Below] [Context: "### Why lefthook"]
202509.md:103:1 MD034/no-bare-urls Bare URL used [Context: "https://github.com/evilmartian..."]
202509.md:116 MD012/no-multiple-blanks Multiple consecutive blank lines [Expected: 1; Actual: 2]
202509.md:123 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/11"]
202509.md:125:34 MD009/no-trailing-spaces Trailing spaces [Expected: 0 or 2; Actual: 1]
202509.md:167 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/12"]
202509.md:173:81 MD013/line-length Line length [Expected: 80; Actual: 100]
202509.md:177 MD012/no-multiple-blanks Multiple consecutive blank lines [Expected: 1; Actual: 2]

                                      
  ────────────────────────────────────
summary: (done in 0.17 seconds)       
🥊 markdownlint (0.16 seconds)
```

おー。なるほど。たしかに

`--fix` つけて実行してみる。

直してくれたっぽい。

というわけで pre-commit で修正させればいいか。細かいところは今後調整していこう

ただよく見ると h1 が複数あるのと、1行の長さが引き続き怒られている

```sh
Summary: 20 error(s)
202509.md:13 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/09"]
202509.md:98 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/10"]
202509.md:130 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/11"]
202509.md:174 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/12"]
202509.md:180:81 MD013/line-length Line length [Expected: 80; Actual: 100]
202509.md:207:81 MD013/line-length Line length [Expected: 80; Actual: 109]
202509.md:208:81 MD013/line-length Line length [Expected: 80; Actual: 113]
202509.md:209:81 MD013/line-length Line length [Expected: 80; Actual: 113]
202509.md:210:81 MD013/line-length Line length [Expected: 80; Actual: 113]
...
```

この辺はやむをえないだろうということで無視できないか試してみる

[Configuration](https://github.com/DavidAnson/markdownlint/blob/v0.32.1/README.md#configuration) を参考に

`<!-- markdownlint-disable MD013 MD025 -->` をファイルの先頭に追加したら消えたので OK :tada:  

```sh
~/personal/til ![chore/20250912]$ lefthook run pre-commit
╭───────────────────────────────────────╮
│ 🥊 lefthook v1.12.3  hook: pre-commit │
╰───────────────────────────────────────╯
┃  markdownlint ❯ 

markdownlint-cli2 v0.18.1 (markdownlint v0.38.0)
Finding: 202509.md
Linting: 1 file(s)
Summary: 0 error(s)

                                      
  ────────────────────────────────────
summary: (done in 0.16 seconds)       
✔️ markdownlint (0.15 seconds)
```

# 09/16

## ECS on Fargate での EFS 利用について

EFS をマウントするために各 Availability Zone にマウントターゲットを作成している

ECS on Fargate で EFS をマウントする場合はボリューム設定を行うが、マウントターゲットではなくファイルシステム ID を指定する  

マウントターゲットは指定されていないがタスク起動時のサブネットの Availability Zone に応じて存在するマウントターゲットを利用している

タスク起動時のサブネットの Availability Zone にマウントターゲットがない場合はタスク起動エラーになり `ResourceInitializationError` が表示される

別 Availability Zone のマウントターゲットを自動的に利用するようなことはない

つまり Availability Zone の障害等が発生してマウントターゲットにアクセスできなくなると ECS タスク自体が起動しなくなることがあるので注意が必要
