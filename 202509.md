<!-- h1 と line-length はスルーさせる -->
<!-- markdownlint-disable MD013 MD025 -->

# 09/08

## はじめまして

TIL を始めてみる。

リポジトリ構成は技術カテゴリーで切ったり、月日で切ったり人それぞれっぽい。

とりあえず月ごとのファイルを作成して h1 で日付、h2 でトピックでやってみる。  

X にかくより詳細にブログに書く材料に。くらいのイメージで

# 09/09

## GitHub CLI でディレクトリごとに認証する

gh コマンドで実現するパターン

会社アカウントと個人アカウントを使い分ける場合

ログイン状況確認

```sh
gh auth status
```

会社用アカウントでログインしている

```sh
~/personal/til +[chore/20250909]$ gh auth status 
github.com
  ✓ Logged in to github.com account company_account (keyring)
  - Active account: true
  - Git operations protocol: https
  - Token: gho_************************************
  - Token scopes: 'gist', 'read:org', 'repo', 'workflow'
```

個人アカウントをブラウザでログインした状態でログインを実施する

```sh
gh auth login
```

個人アカウントにログインできる

```sh
~/personal/til +[chore/20250909]$ gh auth login 
? Where do you use GitHub? GitHub.com
? What is your preferred protocol for Git operations on this host? HTTPS
? Authenticate Git with your GitHub credentials? Yes
? How would you like to authenticate GitHub CLI? Login with a web browser

! First copy your one-time code: xxxx-xxxx
Press Enter to open https://github.com/login/device in your browser... 
✓ Authentication complete.
- gh config set -h github.com git_protocol https
✓ Configured git protocol
✓ Logged in as personal_account
```

ログイン状態の確認をすると以下

```sh
~/personal/til +[chore/20250909]$ gh auth status
github.com
  ✓ Logged in to github.com account personal_account (keyring)
  - Active account: true
  - Git operations protocol: https
  - Token: gho_************************************
  - Token scopes: 'gist', 'read:org', 'repo', 'workflow'

  ✓ Logged in to github.com account company_account (keyring)
  - Active account: false
  - Git operations protocol: https
  - Token: gho_************************************
  - Token scopes: 'gist', 'read:org', 'repo', 'workflow'
```

`Active account: true` になっている方が今選択されているアカウント

切り替えるには auth switch で切り替える

```sh
gh auth swith
```

次のように表示される

```sh
~/personal/til +[chore/20250909]$ gh auth switch
✓ Switched active account for github.com to company_account
```

これでもいいけど特定ディレクトリ配下だけ固定しておきたい。
明日ためそう。

# 09/10

## lefthook

Go で書かれた Git の hook を管理するツール

- <https://github.com/evilmartians/lefthook>
- <https://lefthook.dev/>

Huskey では Node 環境が必要だがこちらはバイナリのみで動作する

### Why lefthook

<https://github.com/evilmartians/lefthook?tab=readme-ov-file#why-lefthook>

Lefthook のよいところ

- 並列実行が可能な parallel オプションが有る
- Glob と filter で実行対象の絞り込みや除外が柔軟に可能
- ジョブごとに Current Working Directory を指定することができ、モノレポ構成等でも設定しやすい
- 任意のコマンドだけではなくスクリプトを実行することもできる
- docker イメージの実行も可能
- lefthook.yml を利用して hook を管理することができ、lefthook-local.yml を用意することで個人設定も追加可能
- lefthook run pre-commit で随時実行も可能
- タスクランナー的利用方法もできる

### 所感

設定して使ってみたけど便利。並列実行はコミットで待たされることがなくよさそう

このリポジトリでも設定してみるか

# 09/11

## kms の alias の terraform import

import しようとすると `Error: Cannot import non-existent remote object` が表示されて困った

```imports.tf
import {
  to = aws_kms_key.hoge
  id = "arn:aws:kms:....."
}

import {
  to = aws_kms_alias.hoge
  id = "dev/kagidayo"
}
```

問題なさそうに見えていたのだが正しくはこう

```tf
import {
  to = aws_kms_key.hoge
  id = "arn:aws:kms:....."
}

import {
  to = aws_kms_alias.hoge
  id = "alias/dev/kagidayo"
}
```

`alias/` が抜けていたのであった....

```diff
 import {
   to = aws_kms_alias.hoge
-  id = "dev/kagidayo"
+  id = "alias/dev/kagidayo"
 }
```

30分くらい調べたよ...

# 09/12

## pre-commit hook 試してみる

テキストとマークダウンの lint を試してみる

[markdownlint-cli2](https://github.com/DavidAnson/markdownlint-cli2) という linter が brew でインストールできるらしい

インストールして lefthook に設定してみる

```yaml:lefthook.yml
---
pre-commit:
  jobs:
    - name: markdownlint
      glob: "*.md"
      run: markdownlint-cli2 {staged_files}
```

手動で `lefthook run pre-commit` してみた

```sh
~/personal/til ![chore/20250912]$ lefthook run pre-commit                    
╭───────────────────────────────────────╮
│ 🥊 lefthook v1.12.3  hook: pre-commit │
╰───────────────────────────────────────╯
sync hooks: ✔️ (pre-commit)
┃  markdownlint ❯ 

markdownlint-cli2 v0.18.1 (markdownlint v0.38.0)
Finding: 202509.md
Linting: 1 file(s)
Summary: 19 error(s)
202509.md:13 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/09"]
202509.md:22 MD031/blanks-around-fences Fenced code blocks should be surrounded by blank lines [Context: "```sh"]
202509.md:27 MD031/blanks-around-fences Fenced code blocks should be surrounded by blank lines [Context: "```sh"]
202509.md:38 MD031/blanks-around-fences Fenced code blocks should be surrounded by blank lines [Context: "```sh"]
202509.md:43 MD031/blanks-around-fences Fenced code blocks should be surrounded by blank lines [Context: "```sh"]
202509.md:59 MD031/blanks-around-fences Fenced code blocks should be surrounded by blank lines [Context: "```sh"]
202509.md:84 MD031/blanks-around-fences Fenced code blocks should be surrounded by blank lines [Context: "```sh"]
202509.md:92 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/10"]
202509.md:97 MD032/blanks-around-lists Lists should be surrounded by blank lines [Context: "- https://github.com/evilmarti..."]
202509.md:97:3 MD034/no-bare-urls Bare URL used [Context: "https://github.com/evilmartian..."]
202509.md:98:3 MD034/no-bare-urls Bare URL used [Context: "https://lefthook.dev/"]
202509.md:102 MD022/blanks-around-headings Headings should be surrounded by blank lines [Expected: 1; Actual: 0; Below] [Context: "### Why lefthook"]
202509.md:103:1 MD034/no-bare-urls Bare URL used [Context: "https://github.com/evilmartian..."]
202509.md:116 MD012/no-multiple-blanks Multiple consecutive blank lines [Expected: 1; Actual: 2]
202509.md:123 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/11"]
202509.md:125:34 MD009/no-trailing-spaces Trailing spaces [Expected: 0 or 2; Actual: 1]
202509.md:167 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/12"]
202509.md:173:81 MD013/line-length Line length [Expected: 80; Actual: 100]
202509.md:177 MD012/no-multiple-blanks Multiple consecutive blank lines [Expected: 1; Actual: 2]

                                      
  ────────────────────────────────────
summary: (done in 0.17 seconds)       
🥊 markdownlint (0.16 seconds)
```

おー。なるほど。たしかに

`--fix` つけて実行してみる。

直してくれたっぽい。

というわけで pre-commit で修正させればいいか。細かいところは今後調整していこう

ただよく見ると h1 が複数あるのと、1行の長さが引き続き怒られている

```sh
Summary: 20 error(s)
202509.md:13 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/09"]
202509.md:98 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/10"]
202509.md:130 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/11"]
202509.md:174 MD025/single-title/single-h1 Multiple top-level headings in the same document [Context: "09/12"]
202509.md:180:81 MD013/line-length Line length [Expected: 80; Actual: 100]
202509.md:207:81 MD013/line-length Line length [Expected: 80; Actual: 109]
202509.md:208:81 MD013/line-length Line length [Expected: 80; Actual: 113]
202509.md:209:81 MD013/line-length Line length [Expected: 80; Actual: 113]
202509.md:210:81 MD013/line-length Line length [Expected: 80; Actual: 113]
...
```

この辺はやむをえないだろうということで無視できないか試してみる

[Configuration](https://github.com/DavidAnson/markdownlint/blob/v0.32.1/README.md#configuration) を参考に

`<!-- markdownlint-disable MD013 MD025 -->` をファイルの先頭に追加したら消えたので OK :tada:  

```sh
~/personal/til ![chore/20250912]$ lefthook run pre-commit
╭───────────────────────────────────────╮
│ 🥊 lefthook v1.12.3  hook: pre-commit │
╰───────────────────────────────────────╯
┃  markdownlint ❯ 

markdownlint-cli2 v0.18.1 (markdownlint v0.38.0)
Finding: 202509.md
Linting: 1 file(s)
Summary: 0 error(s)

                                      
  ────────────────────────────────────
summary: (done in 0.16 seconds)       
✔️ markdownlint (0.15 seconds)
```

# 09/16

## ECS on Fargate での EFS 利用について

EFS をマウントするために各 Availability Zone にマウントターゲットを作成している

ECS on Fargate で EFS をマウントする場合はボリューム設定を行うが、マウントターゲットではなくファイルシステム ID を指定する  

マウントターゲットは指定されていないがタスク起動時のサブネットの Availability Zone に応じて存在するマウントターゲットを利用している

タスク起動時のサブネットの Availability Zone にマウントターゲットがない場合はタスク起動エラーになり `ResourceInitializationError` が表示される

別 Availability Zone のマウントターゲットを自動的に利用するようなことはない

つまり Availability Zone の障害等が発生してマウントターゲットにアクセスできなくなると ECS タスク自体が起動しなくなることがあるので注意が必要

# 09/17

## Opensearch での AZ 障害

3AZ 構成の場合に AZ 障害が起きた場合も動作は継続するが、残りの 2AZ で起動するわけではなく縮退運用になる

# 09/18

## AWS アカウントで不要なリージョンを無効化する

スタンドアロンアカウントで不要なリージョンを無効化しようとしたができなかった

無効化できるのは2019年3月以降に追加されたリージョンだけらしい

<https://docs.aws.amazon.com/ja_jp/accounts/latest/reference/manage-acct-regions.html#manage-acct-regions-considerations>

スタンドアロンアカウントでは無効化できない代わりに IAM ポリシーで制限、もしくは Organization で SCP を利用した制御が必要らしい

Organization やるかあ...

## GitHub で Actions が失敗していたらマージさせない

GitLab ではリポジトリのパイプラインが成功していないとマージできないようにすることが、リポジトリの設定を有効化するだけで可能
<https://docs.gitlab.co.jp/ee/user/project/merge_requests/merge_when_pipeline_succeeds.html#require-a-successful-pipeline-for-merge>

GitHub でもさくっと実現できるだろうと思っていたけど難しいようだ...

ブランチ保護ルールでマージ前にチェック（ワークフロー）のステータスを確認する必要がある

<https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-rulesets/available-rules-for-rulesets#require-status-checks-to-pass-before-merging>

これだけなら良さそうだがどのチェックが成功したか指定しないとダメ

空にしたまま保存すると `Required status checks cannot be empty. Please add at least one status check or disable the rule.` エラーで保存できない

# 09/19

## npm install 時のエラー対応

403 になって困っているとのことだったので調べた

どのユーザーでアクセスしてるかを確認するために以下のコマンドを使った

```sh
npm whoami --registry=https://npm.pkg.github.com
```

npm i とか npm ci とかしか使わないからしらなかったな

あとはこのあたりも

```sh
npm config list
```

結局 github への認証に正しいユーザーだけじゃなく別のアカウントがある状態が怪しかったので、ログアウトしてもらって再度ログインしてトークンを発行してもらった

gh コマンドはこんな感じ

状況確認

```sh
gh auth status
```

ログアウト

```sh
gh auth logout -h github.com -u INVALID_USER_NAME
```

ポイントは不要な認証情報を削除してから再度 `gh auth login && gh auth token` することだったぽい

# 09/22

## オーナーシップについて

良かったのでメモ

<https://nekogata.hatenablog.com/entry/2025/09/22/094637>

- エンジニアがオーナーシップを持ちたくない場合は仕方ない
- エンジニががオーナーシップを持ちたいのに持てない場合に考えられることとして『越境が難しい構造』があるのでは
- 『こうしたほうがいいのでは？』という考えや言葉がオーナーシップの発露
- エンジニアのオーナーシップには3つのレベルがあると考えている
  - **システムに対して**オーナーシップを持つ
    - システムを期待通りに動かす責任の一端を担っている
  - **プロダクトに対して**オーナーシップを持つ
    - ユーザーの課題を解決するプロダクトの挙動を決める責任の一端を担っている
  - **ビジネスとして**オーナーシップを持つ
    - ユーザーの課題を解決するプロダクトの挙動を、ステークホルダーとも調整して決める責任の一端を担っている
- まずシステムに関することで口出し、手出しすることがオーナーシップの獲得につながっていく
- そうすることで発露したオーナーシップは周囲からの信頼の獲得につながり、越境する際に役立っていく

僕がインフラエンジニアというロールでいろいろと話すこと、関わることは、ソフトウェアエンジニアから見ると越境してきてくれているように見えて信頼を獲得しやすかったのかもな。等と思うのであった

# 09/24

## GitHub Actions の workflow_ イベントについて

ワークフローは GitHub イベントをトリガーにして起動させることができる

- `workflow_call` 別のワークフローからワークフローを呼び出す
- `workflow_dispatch` ワークフローを手動トリガーできるようにする
- `workflow_run` ワークフローの実行が要求されたか完了したとき

workflow_call と workflow_run の違いとしては以下

- `workflow_call` は即時実行。`workflow_run` は指定ワークフローの完了後
- `workflow_call` は主に Reusable Workflows として利用される（のでパラメーターを渡すことができる）

# 09/25

## キャッチオールアドレス

メールサーバーで設定することで、存在しないメールアドレスや正しくないメールアドレスへのメール送信を受信することができる

Google での設定はこちら

<https://support.google.com/a/answer/12943537?hl=ja>

これを利用することでメールアドレスの間違い等を防ぐことができるがスパムが大量に届くことになる可能性もあるので注意

ちなみに Office とか SES、Sendgrid とかではできなさそう

# 09/26

## GitHub の workflows_run について

workflows_run でトリガーされて実行されたワークフロー自体はデフォルトブランチで実行されるので注意

ドキュメントでも `GITHUB_REF` はデフォルトブランチになっている

<https://docs.github.com/ja/actions/reference/workflows-and-actions/events-that-trigger-workflows#workflow_run>

workflows_run の branch で指定できるブランチはあくまでも、トリガーとなるワークフローのブランチということらしい

> たとえば、次のトリガーを持つワークフローは、名前が canary のブランチで Build という名前のワークフローが実行される場合にのみ実行されます。
>
> ```yml
> on:
>   workflow_run:
>     workflows: [Build]
>     types: [requested]
>     branches: [canary]
> ```
>
> <https://docs.github.com/ja/actions/reference/workflows-and-actions/events-that-trigger-workflows#limiting-your-workflow-to-run-based-on-branches>

またトリガーされたワークフローのジョブはトリガー元の成功、失敗にかかわらず実行されてしまう

ジョブでステータスをチェックする必要がある

```yml
jobs:
  workflow_run_de_deyobareta_job:
    # ステータスチェックが必要なので注意
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - ...
```

# 09/29

## Public ECR からの pull について

GitHub Actions で Public ECR からの pull が 429 too many requests となり rate limit error を返していた

Public ECR って制限あるんだっけ？と思って調べたら以下がわかった

- Public ECR は AWS 以外から利用する場合 pull 制限がかかる
- 認証なしの場合の pull は1秒間に1回
- 認証した場合の pull は1秒間に10回

[Amazon ECR Public service quotas](https://docs.aws.amazon.com/ja_jp/AmazonECR/latest/public/public-service-quotas.html) に記載されている

というわけで GitHub Actions で利用する場合は認証したほうがよい

ただ GitHub Actions であれば dockerhub の制限に引っかからないという噂もある

Refs: <https://www.codingfeline.com/2023/07/28/github-actions-public-ecr-toomanyrequests/>

それならそっちのほうが楽でいいな〜

# 09/30

## VS Code で AI ツールを利用する

VS Code に次の拡張機能の追加が必要

- GitHub Copilot
- GitHub Copilot Chat

次の機能が利用できる

- Code completion
  - コードの自動補完
  - Next Edit Suggestion という機能もある
- Copilot Chat
  - チャット形式でコード生成や修正を行う
  - カスタムインストラクションとして `.github/copilot-instructions.md` に指示を記載できる
    - インストラクションというのは「AIのふるまいのルール」のこと
  - プロンプトファイルは「質問や指示のテンプレート」
  - コンテキストは「今の作業状況やファイル内容」
  - モードが3つある
    - Ask
      - コンテキストを伴った対話を行うためのモード
    - Edit
      - Agent モード以前に利用されていたモード？
      - Agent モードより限定的な場面での編集の依頼等に利用できる
    - Agent
      - さまざまなタスクを自律的に実行してくれるモード

`^+cmd+I` でチャットが開ける

Copilot Chat で利用できるモデルは基本的には Copilot にログインしている GitHub アカウントに紐づくものになる
Gemini の拡張機能をインストールすることで Copilot Chat でもモデルに表示される
